
=================Comandos del LAB 6============================

=================PRÁCTICA 1============================

Instalación y configuración de GPG2
sudo dnf install gnupg2 -y


Primero instalo la herramienta GPG2 para poder cifrar y descifrar archivos.
Si ya está instalada, el sistema me lo indica automáticamente.

Creación del entorno de trabajo y archivo a cifrar
mkdir ~/gpg_prueba
cd ~/gpg_prueba
echo "Texto secreto" > archivo.txt
cat archivo.txt


Creo una carpeta para la práctica y dentro de ella un archivo con el mensaje que quiero proteger.
Verifico que el contenido se haya guardado correctamente.

Generación y verificación de la clave GPG
gpg --gen-key


Genero mi clave GPG y completo los datos: nombre, correo, tamaño de clave (4096 bits) y contraseña.
Esa información forma mi identidad GPG, que incluye el nombre de usuario (el que puse al crear la clave).

Por ejemplo:
Nombre: Luis_Mendez
Correo: luiseduardok720@gmail.com

Ese nombre (“Luis_Mendez”) es el que usaré más adelante en el comando --recipient.

gpg --list-keys
Verifico que la clave aparezca correctamente en la lista.

Cifrado del archivo
cd ~/gpg_prueba
gpg2 --encrypt --recipient "<NOMBRE_USUARIO>" archivo.txt

Aquí reemplazo <NOMBRE_USUARIO> por el nombre que usé al generar la clave (por ejemplo, Luis_Mendez).
Con esto se crea un archivo protegido llamado archivo.txt.gpg.

Intento de acceso al archivo cifrado
cat archivo.txt.gpg


Intento leer el archivo cifrado y veo que solo aparecen caracteres extraños.
Eso confirma que el contenido está encriptado y no se puede leer sin la clave privada.

Descifrado y comprobación del contenido
gpg2 --decrypt archivo.txt.gpg
Descifro el archivo para recuperar el texto original.
El sistema muestra “Texto secreto”, lo que indica que el cifrado y descifrado funcionaron correctamente.




=================PRÁCTICA 2============================


1. Habilitar servicios http, ftp, ssh:
Instala e inicia servicios:
- HTTP: sudo dnf install httpd y sudo systemctl start httpd && sudo systemctl enable httpd
- FTP: sudo dnf install vsftpd y sudo systemctl start vsftpd && sudo systemctl enable vsftpd

Otra manera de instalar:
sudo dnf install httpd vsftpd -y
sudo systemctl enable --now httpd vsftpd sshd

- SSH usualmente está instalado: sudo systemctl start sshd && sudo systemctl enable sshd
- Verifica servicios: systemctl status httpd vsftpd sshd

2. Bloquear puertos con iptables

reglas para bloquear el tráfico a los puertos 80, 21 y 22:

sudo iptables -A INPUT -p tcp --dport 80 -j DROP
sudo iptables -A INPUT -p tcp --dport 21 -j DROP
sudo iptables -A INPUT -p tcp --dport 22 -j DROP


Verificar las reglas con:

sudo iptables -L

Comprobar que las reglas hayan sido aplicadas
http://<IP-del-servidor>
ftp <IP-del-servidor>
ssh nombre_de_usuario@<IP-del-servidor>

3. Permitir nuevamente con iptables

Eliminar las reglas que bloqueaban el tráfico:

sudo iptables -D INPUT -p tcp --dport 80 -j DROP
sudo iptables -D INPUT -p tcp --dport 21 -j DROP
sudo iptables -D INPUT -p tcp --dport 22 -j DROP
Esto restaura el acceso.

http://<IP-del-servidor>
ftp <IP-del-servidor>
ssh nombre_de_usuario@<IP-del-servidor>



4. Bloquear servicios con firewall-cmd

firewalld, que es lo correcto para Red Hat:

sudo firewall-cmd --permanent --remove-service=http
sudo firewall-cmd --permanent --remove-service=ftp
sudo firewall-cmd --permanent --remove-service=ssh
sudo firewall-cmd --reload

Con esto bloqueo el tráfico hacia esos servicios.

http://<IP-del-servidor>
ftp <IP-del-servidor>
ssh nombre_de_usuario@<IP-del-servidor>



5. Volver a habilitar los servicios

Finalmente, los volviste a permitir:

sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=ftp
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload


http://<IP-del-servidor>
ftp <IP-del-servidor>
ssh nombre_de_usuario@<IP-del-servidor>


=================PRÁCTICA 3============================

Actualizar sistema
sudo dnf update -y && sudo dnf update -y

Habilitar los repositorios necesarios (EPEL y CodeReady Builder)
sudo dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm -y
sudo subscription-manager repos --enable codeready-builder-for-rhel-8-$(arch)-rpms

Configurar librerías
sudo nano /etc/ld.so.conf.d/local.conf


Agregar dentro del archivo:

/usr/local/lib
/usr/local/lib64


Guardar, cerrar y actualizar el caché de librerías:

sudo ldconfig

Instalar dependencias
sudo dnf install flex bison gcc gcc-c++ make cmake autoconf libtool git nano unzip wget \
libpcap-devel pcre-devel hwloc-devel openssl-devel zlib-devel luajit-devel \
pkgconfig pkgconf libunwind-devel libnfnetlink-devel libnetfilter_queue-devel \
libmnl-devel xz-devel gperftools libuuid-devel hyperscan hyperscan-devel -y

Instalar la dependencia libdnet desde GitHub
cd ~
git clone https://github.com/dugsong/libdnet.git
cd libdnet
./configure --without-check
make
sudo make install
sudo ldconfig

Instalar libdaq (Data Acquisition Library para Snort)
git clone https://github.com/snort3/libdaq.git
cd libdaq
./bootstrap && ./configure && make && sudo make install
sudo ldconfig && cd ..

Instalar libpcre2 y su paquete de desarrollo
sudo dnf install pcre2 pcre2-devel -y

Instalar Snort 3
git clone https://github.com/snort3/snort3.git
cd snort3

export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
export PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig:$PKG_CONFIG_PATH
export CFLAGS="-O3"
export CXXFLAGS="-O3 -fno-rtti"

./configure_cmake.sh --prefix=/usr/local/snort --enable-tcmalloc
cd build/ && make -j$(nproc) && sudo make -j$(nproc) install
cd ../.. && sudo ldconfig

Crear enlace simbólico (acceso directo a Snort)
sudo ln -s /usr/local/snort/bin/snort /usr/bin/snort

Verificar la instalación
snort -V

9) Crear estructura de reglas locales

sudo mkdir -p /usr/local/snort/etc/rules
sudo nano /usr/local/snort/etc/rules/local.rules


Poner dentro del archivo estas reglas:

# Regla 1 - Detectar ICMP (ping)
alert icmp any any -> $HOME_NET any (msg:"ICMP Ping detectado"; sid:1000001; rev:1;)

# Regla 2 - Detectar tráfico hacia el puerto 21 (FTP)
alert tcp any any -> $HOME_NET 21 (msg:"Intento de acceso FTP detectado"; sid:1000002; rev:1;)

# Regla 3 - Detectar tráfico hacia el puerto 22 (SSH)
alert tcp any any -> $HOME_NET 22 (msg:"Intento de acceso SSH detectado"; sid:1000003; rev:1;)

# Regla 4 - Detectar tráfico hacia el puerto 80 (HTTP)
alert tcp any any -> $HOME_NET 80 (msg:"Intento de acceso HTTP detectado"; sid:1000004; rev:1;)


Guarda (Ctrl+O, Enter) y cierra (Ctrl+X).

10) Validar configuración de Snort
sudo snort -T \
  -c /usr/local/snort/etc/snort/snort.lua \
  -R /usr/local/snort/etc/rules/local.rules

11) Ejecutar Snort como IDS (en ens160)

sudo snort \
  -c /usr/local/snort/etc/snort/snort.lua \
  -R /usr/local/snort/etc/rules/local.rules \
  -i ens160 -A alert_fast

ens160 es el nombre de mi interfaz de red, en caso de no saber cual es el nombre de mi interfaz 
utilizo el comando: ip a

12) Pruebas desde la máquina host (cliente)
<SNORT_SERVER_IP>: IP del servidor donde corre Snort.

ICMP (Ping)
ping <SNORT_SERVER_IP>

FTP (21/TCP)
Aun sin servidor FTP activo, Snort puede detectar el intento (SYN).
ftp <SNORT_SERVER_IP>

SSH (22/TCP)
Si falla la autenticación es normal; a Snort le basta el tráfico.
ssh <SNORT_SERVER_IP>

HTTP (80/TCP)
Opción rápida con Python (si no tienes Apache):
sudo dnf install -y python3
sudo python3 -m http.server 80
Desde el host, abrir en el navegador:
# http://<SNORT_SERVER_IP>


Alternativa con Apache:

sudo dnf install -y httpd
sudo systemctl enable --now httpd


Mientras pruebas, en la ventana de Snort verás alertas similares a:

[**] [1:1000001:1] "ICMP Ping detectado" [**]
[**] [1:1000002:1] "Intento de acceso FTP detectado" [**]
[**] [1:1000003:1] "Intento de acceso SSH detectado" [**]
[**] [1:1000004:1] "Intento de acceso HTTP detectado" [**]


Debe indicar que la configuración se validó correctamente.

13) (Opcional) Guardar evidencias en archivos de log
Crear carpeta de logs y ejecutar Snort en modo alerta rápida:

sudo mkdir -p /var/log/snort
sudo snort \
  -c /usr/local/snort/etc/snort/snort.lua \
  -R /usr/local/snort/etc/rules/local.rules \
  -i <INTERFAZ_DE_RED> -A alert_fast -l /var/log/snort


Reemplazar <INTERFAZ_DE_RED> por tu interfaz (ej.: ens160, eth0, etc.).

Ver las alertas:
cat /var/log/snort/alert_fast.txt

=================PRÁCTICA 4============================

PRÁCTICA 4: CONFIGURACIÓN DE AUTENTICACIÓN DE DOS FACTORES (2FA) CON GOOGLE AUTHENTICATOR

PASO 1: INSTALACIÓN DE DEPENDENCIAS

sudo dnf install -y epel-release
sudo dnf install -y google-authenticator qrencode-libs chrony
sudo systemctl enable --now chronyd


PASO 2: CONFIGURACIÓN DE GOOGLE AUTHENTICATOR
IMPORTANTE: Ejecutar como usuario normal, NO como root

google-authenticator -t -d -f -r 3 -R 30 -W
chmod 600 ~/.google_authenticator
cp ~/.google_authenticator ~/.google_authenticator~readonly
chmod 444 ~/.google_authenticator~readonly


PASO 3: CONFIGURACIÓN DE CONTEXTO SELINUX

sudo chcon -t user_home_t ~/.google_authenticator~readonly

sudo cat > google_auth_complete.te << 'EOF'
module google_auth_complete 1.0;
require {
    type sshd_t;
    type user_home_t;
    type auth_home_t;
    class file { create write unlink read getattr setattr };
    class dir { search write add_name remove_name };
}
allow sshd_t user_home_t:file { create write unlink read getattr setattr };
allow sshd_t auth_home_t:file { create write unlink read getattr setattr };
allow sshd_t user_home_t:dir { search write add_name remove_name };
EOF

sudo checkmodule -M -m -o google_auth_complete.mod google_auth_complete.te
sudo semodule_package -o google_auth_complete.pp -m google_auth_complete.mod
sudo semodule -i google_auth_complete.pp


PASO 4: LIMPIEZA DE CONFIGURACIÓN SSH EXISTENTE
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

sudo sed -i '/^ChallengeResponseAuthentication/d' /etc/ssh/sshd_config
sudo sed -i '/^PasswordAuthentication/d' /etc/ssh/sshd_config
sudo sed -i '/^PubkeyAuthentication/d' /etc/ssh/sshd_config
sudo sed -i '/^KbdInteractiveAuthentication/d' /etc/ssh/sshd_config
sudo sed -i '/^AuthenticationMethods/d' /etc/ssh/sshd_config
sudo sed -i '/^LogLevel/d' /etc/ssh/sshd_config


PASO 5: APLICACIÓN DE CONFIGURACIÓN SSH

sudo tee -a /etc/ssh/sshd_config << 'EOF'
UsePAM yes
ChallengeResponseAuthentication yes
KbdInteractiveAuthentication yes
PasswordAuthentication no
PubkeyAuthentication no
AuthenticationMethods keyboard-interactive
LogLevel VERBOSE
EOF


PASO 6: CONFIGURACIÓN DE PAM PARA SSH

sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.backup

sudo tee /etc/pam.d/sshd << 'EOF'
#%PAM-1.0
auth       sufficient   pam_google_authenticator.so nullok secret=/home/USUARIO/.google_authenticator~readonly
auth       required     pam_unix.so nullok try_first_pass
account    required     pam_unix.so
password   required     pam_unix.so
session    required     pam_unix.so
session    required     pam_selinux.so close
session    required     pam_loginuid.so
session    required     pam_selinux.so open env_params
session    optional     pam_keyinit.so force revoke
session    required     pam_namespace.so
EOF


PASO 7: VERIFICACIÓN DE CONFIGURACIONES
sudo sshd -t
sudo sshd -T | grep -i challengeresponse
ls -lZ ~/.google_authenticator~readonly


PASO 8: REINICIO DE SERVICIOS Y LIMPIEZA
sudo systemctl restart sshd
sudo faillock --user USUARIO --reset


PASO 9: VERIFICACIÓN FINAL
sudo sshd -T | grep -i -E "(challenge|keyboard|usepam|passwordauth|authent)"


Salida esperada:
- `challengeresponseauthentication yes`
- `kbdinteractiveauthentication yes`
- `passwordauthentication no`
- `usepam yes`

PASO 10: PRUEBA DE CONEXIÓN

⦁	Desde cliente externo
ssh -o PreferredAuthentications=keyboard-interactive USUARIO@IP_SERVIDOR

⦁	Conexión alternativa
ssh USUARIO@IP_SERVIDOR


Notas importantes:
- Reemplazar `USUARIO` con el nombre de usuario real
- Reemplazar `IP_SERVIDOR` con la dirección IP del servidor
- Mantener sesión administrativa abierta durante las pruebas
- Verificar que el archivo ~/.google_authenticator~readonly tenga los permisos correctos
